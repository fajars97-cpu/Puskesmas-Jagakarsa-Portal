<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Penampil Bagan SOP</title>
  <style>
    /* ============ TOKENS ============ */
    :root{
      --brand:#20733a;               /* hijau puskesmas */
      --ink:#0f172a;                 /* teks utama */
      --muted:#667085;               /* teks sekunder */
      --bg:#ffffff;                  /* latar */
      --panel:#f6f8fa;               /* panel abu */
      --border:#e5e7eb;              /* garis halus */
      --radius:12px;
      --footerH:56px;
      --sheetH:74dvh;                /* tinggi sheet mobile */
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:"Segoe UI",system-ui,Arial,sans-serif;background:var(--bg);color:var(--ink)}

    /* ============ APPBAR ============ */
    .appbar{position:sticky;top:0;z-index:20;display:flex;align-items:center;justify-content:space-between;gap:12px;padding:10px 14px;background:var(--brand);color:#fff;border-bottom:1px solid #155a2b;box-shadow:0 2px 12px rgba(0,0,0,.12)}
    .appbar-left{display:flex;align-items:center;gap:10px}
    .brandmark{display:flex;align-items:center;gap:10px}
    .brandmark img{height:36px;width:auto;border-radius:8px;background:#fff;padding:3px;border:1px solid #e6f0ea}
    .title{font-weight:800;letter-spacing:.3px;font-size:clamp(14px,2.5vw,18px)}
    .pill{display:inline-flex;align-items:center;gap:8px;background:#fff;color:var(--brand);text-decoration:none;padding:8px 14px;border-radius:9999px;font-weight:700;border:2px solid transparent;box-shadow:0 2px 8px rgba(0,0,0,.08);cursor:pointer}
    .pill:hover{transform:translateY(-1px)}

    /* ============ LAYOUT ============ */
    .container{display:flex;min-height:calc(100dvh - var(--footerH))}
    @supports not (height: 100dvh){ .container{min-height:calc(100vh - var(--footerH))} }
    .sidebar{width:28%;max-width:420px;background:var(--panel);padding:18px;border-right:1px solid var(--border);overflow-y:auto}
    .content{flex:1 1 auto;display:flex;flex-direction:column;min-width:0}

    /* ============ DASHBOARD CHIPS ============ */
    #dashboard-stats{display:flex;gap:12px;align-items:center;padding:10px 12px;border-bottom:1px solid var(--border);background:#fff;position:sticky;top:0;z-index:5;box-shadow:0 6px 12px -12px rgba(0,0,0,.3)}
    #dashboard-stats{overflow-x:auto;-webkit-overflow-scrolling:touch;scrollbar-width:none}
    #dashboard-stats::-webkit-scrollbar{display:none}
    .chip{flex:0 0 auto;min-width:122px;text-align:center;padding:12px 14px;border-radius:14px;border:1px solid #b2dfdb;background:#e8f5e9;box-shadow:0 2px 8px rgba(80,160,120,.06)}
    .chip .stat-count{font-weight:800;color:#1b5e20}
    .chip .stat-label{font-size:12px;color:#2e7d32;margin-top:3px}

    /* ============ MAIN ============ */
    .main{flex:1 1 auto;overflow:auto;padding:16px}
    .msg{min-height:120px;animation:fade .35s}
    .sop-img{margin-top:10px;border:1px solid #e5e7eb;border-radius:14px;box-shadow:0 8px 28px rgba(0,0,0,.06);cursor:zoom-in;max-width:100%;height:auto;background:#fff}

    /* ============ SIDEBAR ============ */
    .org{display:flex;align-items:center;gap:10px;margin-bottom:14px;font-weight:800;color:#007b83}
    .org img{height:40px;width:auto;border-radius:8px;background:#fff;border:1px solid #b2dfdb}
    label{font-size:12px;color:var(--muted)}
    input,select,button{width:100%;padding:12px 12px;border-radius:10px;border:1px solid var(--border);margin:8px 0;font-size:15px}
    button{background:var(--brand);color:#fff;font-weight:800;display:flex;align-items:center;gap:8px;justify-content:center;transition:transform .15s,box-shadow .2s}
    button:hover{transform:translateY(-1px);box-shadow:0 6px 16px rgba(32,115,58,.25)}
    button:active{transform:translateY(0)}
    ul#sop-list{list-style:none;padding:0;margin:10px 0}
    ul#sop-list li{display:flex;align-items:center;justify-content:space-between;gap:8px;padding:12px 14px;background:#fff;margin-bottom:8px;border-radius:10px;border:1px solid var(--border);font-size:15px;transition:background .18s,box-shadow .18s}
    ul#sop-list li:hover,ul#sop-list li.active{background:#f2f4f5}
    ul#sop-list li .chev{opacity:.5}
    .alert{color:#b94a48;background:#fef2f2;padding:10px 12px;border-radius:10px;margin-bottom:10px;border:1px solid #fecaca;font-size:14px}

    /* ============ FOOTER ============ */
    footer{position:fixed;inset:auto 0 0 0;height:calc(var(--footerH) + env(safe-area-inset-bottom));display:grid;place-items:center;background:#f9f9f9;border-top:1px solid var(--border);color:#6b7280;font-size:14px;padding-bottom:env(safe-area-inset-bottom)}

    /* ============ MOBILE BOTTOM SHEET ============ */
    .bottom-toggle{position:fixed;left:50%;transform:translate(-50%,0);transition:transform .25s,opacity .25s;bottom:calc(var(--footerH) + 10px + env(safe-area-inset-bottom));z-index:45;display:none;align-items:center;gap:8px;height:44px;padding:10px 12px;border-radius:9999px;border:none;background:var(--brand);color:#fff;font-weight:800;box-shadow:0 12px 30px rgba(32,115,58,.28);white-space:nowrap;max-width:220px;width:auto}
    .bottom-toggle svg{width:18px;height:18px;flex:0 0 auto}
    .bottom-toggle .label{display:inline}
    @media (max-width:380px){ .bottom-toggle .label{display:none} }
    .bottom-toggle svg{flex:0 0 auto}
    .overlay{position:fixed;inset:0;background:rgba(0,0,0,.28);backdrop-filter:blur(1px);z-index:43;display:none}
    .overlay.show{display:block}
    .bottom-toggle.hide{opacity:0;transform:translate(-50%,16px);pointer-events:none}
    .sheet{position:fixed;left:0;right:0;bottom:0;z-index:44;background:#fff;border-top-left-radius:18px;border-top-right-radius:18px;box-shadow:0 -10px 40px rgba(0,0,0,.25);transform:translateY(100%);transition:transform .28s ease;will-change:transform;overscroll-behavior-y:contain}
    .sheet.open{transform:translateY(0)}
    .sheet.dragging{transition:none;user-select:none}
    .sheet-head{position:sticky;top:0;z-index:1;display:flex;align-items:center;justify-content:space-between;padding:10px 12px;background:#fff;border-bottom:1px solid var(--border);box-shadow:0 2px 10px -10px rgba(0,0,0,.25);user-select:none}
    .sheet-head,.drag{touch-action:none}
    .sheet-head,.drag{touch-action:none}
    .drag{width:36px;height:4px;border-radius:999px;background:#d1d5db;margin:6px auto}
    .sheet-body{max-height:var(--sheetH);overflow:auto;padding:12px 16px;overscroll-behavior:contain;-webkit-overflow-scrolling:touch}

    /* ============ MOBILE ============ */
    @media (max-width: 1024px){ .sidebar{width:36%} }
    @media (max-width: 900px){
      .appbar{padding:10px 12px}
      /* Sembunyikan sidebar, pindah filter ke bottom sheet */
      .sidebar{display:none}
      .bottom-toggle{display:inline-flex}
    }

    /* ============ ANIM ============ */
    @keyframes fade{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
    @media (prefers-reduced-motion: reduce){ .pill, .sop-img{transition:none} }
    /* Close (ghost icon) */
    .close-btn{width:44px;height:44px;display:grid;place-items:center;border-radius:9999px;background:#fff;border:1px solid #e5e7eb;box-shadow:0 1px 4px rgba(0,0,0,.06);color:#111827}
    .close-btn:hover{background:#f8fafc}
    .close-btn svg{width:18px;height:18px}
  </style>
</head>
<body>
  <header class="appbar">
    <div class="appbar-left">
      <div class="brandmark">
        <img src="../assets/logo_sayur_sop.png" alt="Logo Sayur SOP" loading="lazy" decoding="async" onerror="imgFallback(this,'Logo aplikasi tidak ditemukan')" />
        <div class="title">Penampil Bagan Alir SOP</div>
      </div>
    </div>
    <a class="pill" href="../index.html" aria-label="Home">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true"><path d="M3 10.5 12 3l9 7.5V21a1 1 0 0 1-1 1h-5v-6H9v6H4a1 1 0 0 1-1-1v-10.5Z" stroke="currentColor" stroke-width="1.7" stroke-linecap="round" stroke-linejoin="round"/></svg>
      Home
    </a>
  </header>

  <div class="overlay" id="overlay" onclick="toggleSheet(false)"></div>

  <div class="container">
    <!-- Sidebar desktop -->
    <aside class="sidebar" id="sidebar">
      <div class="org">
        <img src="../assets/logo_puskesmas.png" alt="Logo Puskesmas Jagakarsa" loading="lazy" decoding="async" onerror="imgFallback(this,'Logo Puskesmas tidak ditemukan')" />
        <span>PUSKESMAS JAGAKARSA</span>
      </div>

      <!-- Semua kontrol filter dibungkus agar bisa dipindahkan ke bottom sheet saat mobile -->
      <div id="filtersWrap">
        <div id="alert-box" style="display:none" class="alert"></div>

        <label for="searchInput">Pencarian</label>
        <input type="text" id="searchInput" placeholder="üîé Cari SOP..." aria-label="Cari SOP" />
        <button onclick="triggerSearchFromButton()" aria-label="Tombol Cari">
          <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" aria-hidden="true"><circle cx="11" cy="11" r="7"/><line x1="16.65" y1="16.65" x2="21" y2="21"/></svg>
          Cari
        </button>

        <label for="kategori-select">Kategori</label>
        <select id="kategori-select" onchange="tampilkanSOP()" aria-label="Pilih Kategori">
          <option value="">-- Pilih Kategori --</option>
          <option value="klaster1">Klaster 1</option>
          <option value="klaster2">Klaster 2</option>
          <option value="klaster3">Klaster 3</option>
          <option value="klaster4">Klaster 4</option>
          <option value="klaster5">Klaster 5</option>
        </select>

        <label for="sop-select">SOP</label>
        <select id="sop-select" onchange="showSOP()" aria-label="Pilih SOP">
          <option value="">-- Pilih SOP --</option>
        </select>

        <ul id="sop-list" style="display:none"></ul>
      </div>
    </aside>

    <section class="content">
      <div id="dashboard-stats"></div>
      <main class="main">
        <div id="messages" class="msg">
          <p>üì• Pilih SOP dari sebelah kiri untuk menampilkan bagan alir.</p>
        </div>
      </main>
    </section>
  </div>

  <!-- Toggle button + Bottom sheet (muncul hanya di mobile via CSS) -->
  <button id="filterToggle" class="bottom-toggle" aria-controls="filterSheet" aria-expanded="false" onclick="toggleSheet()" aria-label="Buka pencarian SOP">
    <svg viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M3 6h18M3 12h18M3 18h18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
    <span class="label">Pencarian SOP</span>
  </button>

  <section id="filterSheet" class="sheet" role="dialog" aria-modal="true" aria-labelledby="sheetTitle">
    <div class="drag"></div>
    <div class="sheet-head">
      <strong id="sheetTitle">Pencarian & Filter</strong>
      <button class="close-btn" onclick="toggleSheet(false)" aria-label="Tutup">
        <svg viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M6 6l12 12M18 6L6 18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
      </button>
    </div>
    <div id="sheetBody" class="sheet-body"><!-- filtersWrap akan dipindahkan ke sini di mobile --></div>
  </section>

  <footer>Created by Fajar Setyawan 221788</footer>

  <script>
  const KLASTERS = ['klaster1','klaster2','klaster3','klaster4','klaster5'];
  const SOPS = [
    { id:'alat',       judul:'Pemeliharaan Alat Kesehatan',                 klaster:'klaster1', img:'../assets/bagan_alir_pemeliharaan_alat_kesehatan.png',          icon:'üìä' },
    { id:'kamar',      judul:'Pembersihan Kamar Mandi',                     klaster:'klaster1', img:'../assets/bagan_alir_pembersihan_kamar_mandi.png',               icon:'üöø' },
    { id:'orientasi',  judul:'Orientasi Pegawai Baru',                      klaster:'klaster1', img:'../assets/bagan_orientasi_pegawaibaru.png',                      icon:'üë•' },
    { id:'pengumpulan',judul:'Pengumpulan, Penyimpanan, Pencarian Data',    klaster:'klaster1', img:'../assets/bagan_alir_pengumpulan_penyimpanan_pencarian_data.png', icon:'üóÇÔ∏è' }
  ];
  const sopsById = SOPS.reduce((m,s)=>{ m[s.id]=s; return m; }, {});

  function imgFallback(el,msg){ if(!el) return; el.outerHTML = `<div style="display:inline-flex;align-items:center;justify-content:center;height:${el.height||40}px;min-width:120px;padding:6px 10px;border:1px dashed #c8d6cf;border-radius:8px;color:#456;font-size:12px;background:#f6fbf8">${msg}</div>`; }
  function openFull(el){ if(!el) return; const url = el.src || el.getAttribute('data-src'); if(url) window.open(url,'_blank','noopener'); }

  function renderDashboardStats(){
    const wrap = document.getElementById('dashboard-stats'); if(!wrap) return;
    const names = {klaster1:'Klaster 1',klaster2:'Klaster 2',klaster3:'Klaster 3',klaster4:'Klaster 4',klaster5:'Klaster 5'};
    wrap.innerHTML = KLASTERS.map(k=>{
      const count = SOPS.filter(s=>s.klaster===k).length;
      return `<div class="chip"><div class="stat-count">${count}</div><div class="stat-label">${names[k]}</div></div>`;
    }).join('');
  }

  function tampilkanSOP(){
    document.getElementById('searchInput').value=''; hideAlert();
    const kategori = document.getElementById('kategori-select').value;
    const sopSelect = document.getElementById('sop-select');
    sopSelect.innerHTML = '<option value="">-- Pilih SOP --</option>';
    const hasil = kategori ? SOPS.filter(s=>s.klaster===kategori) : [];
    hasil.forEach(s=>{ const o=document.createElement('option'); o.value=s.id; o.text=s.judul; sopSelect.appendChild(o); });
    const list = document.getElementById('sop-list');
    list.innerHTML = hasil.map(s=>`<li onclick="pilihSOP('${s.id}')">${s.judul}<span class="chev">‚Ä∫</span></li>`).join('');
    list.style.display = hasil.length ? 'block' : 'none';
  }

  function cariSOP(){
    hideAlert();
    const q = document.getElementById('searchInput').value.toLowerCase();
    const sopSelect = document.getElementById('sop-select');
    const kategori = document.getElementById('kategori-select').value;
    sopSelect.innerHTML = '<option value="">-- Pilih SOP --</option>';
    let hasil = [];
    if(q){ hasil = SOPS.filter(s=> s.judul.toLowerCase().includes(q)); }
    else if(kategori){ hasil = SOPS.filter(s=> s.klaster===kategori); }
    hasil.forEach(s=>{ const o=document.createElement('option'); o.value=s.id; o.text = s.judul + (s.klaster?` (${s.klaster.replace('klaster','Klaster ')})`:'' ); sopSelect.appendChild(o); });
    const list = document.getElementById('sop-list');
    list.innerHTML = hasil.map(s=>`<li onclick=\"pilihSOP('${s.id}')\">${s.judul}${s.klaster?` <span style='color:#888;font-size:12px;'>(${s.klaster.replace('klaster','Klaster ')})</span>`:''}<span class='chev'>‚Ä∫</span></li>`).join('');
    list.style.display = hasil.length ? 'block' : 'none';
  }


  function triggerSearchFromButton(){
    cariSOP();
    const sopSelect = document.getElementById('sop-select');
    if(sopSelect.options.length > 1){ sopSelect.selectedIndex = 1; showSOP(); }
  }

  function pilihSOP(nama){
    const sopSelect = document.getElementById('sop-select');
    for(let i=0;i<sopSelect.options.length;i++){ if(sopSelect.options[i].value===nama){ sopSelect.selectedIndex=i; showSOP(); break; }}
    document.querySelectorAll('#sop-list li').forEach(li=>{ li.classList.remove('active'); if(li.textContent.trim().startsWith(sopSelect.options[sopSelect.selectedIndex].text)) li.classList.add('active'); });
  }

  function showSOP(){
    const v = document.getElementById('sop-select').value; const msg=document.getElementById('messages'); msg.style.opacity=0;
    setTimeout(()=>{
      const sop = sopsById[v];
      let html='';
      if(sop){
        const icon = sop.icon || '';
        html = `${icon} ${sop.judul}:<br><img src="${sop.img}" class="sop-img" alt="Bagan Alir ${sop.judul}" loading="lazy" decoding="async" onerror="imgFallback(this,'Gambar tidak ditemukan')" onclick="openFull(this)">`;
      }
      msg.innerHTML = html || '<p>‚ùå SOP belum tersedia.</p>';
      msg.style.animation='none'; void msg.offsetWidth; msg.style.animation=null; msg.style.opacity=1;
      // Auto-close filter sheet on mobile after selecting a SOP
      if (isMobile()) toggleSheet(false);
    },140);
  }

  function showAlert(m){const b=document.getElementById('alert-box'); b.style.display='block'; b.innerText=m}
  function hideAlert(){const b=document.getElementById('alert-box'); b.style.display='none'; b.innerText=''}

  // ===== Bottom Sheet Logic (mobile) =====
  function isMobile(){return window.matchMedia('(max-width: 900px)').matches}
  function placeFilters(){
    const wrap=document.getElementById('filtersWrap');
    const sheetBody=document.getElementById('sheetBody');
    const sidebar=document.getElementById('sidebar');
    if(!wrap||!sheetBody||!sidebar) return;
    if(isMobile()){
      if(wrap.parentElement!==sheetBody) sheetBody.appendChild(wrap);
      const btn=document.getElementById('filterToggle'); if(btn) btn.style.display='inline-flex';
    }else{
      if(wrap.parentElement!==sidebar) sidebar.appendChild(wrap);
      const btn=document.getElementById('filterToggle'); if(btn) btn.style.display='none';
      toggleSheet(false);
    }
  }
  function toggleSheet(open){
    const sheet=document.getElementById('filterSheet');
    const overlay=document.getElementById('overlay');
    const btn=document.getElementById('filterToggle');
    if(!sheet) return;
    const show=(open===undefined)? !sheet.classList.contains('open') : open;
    sheet.classList.toggle('open',show);
    overlay.classList.toggle('show',show);
    if(btn){
      btn.setAttribute('aria-expanded', show? 'true':'false');
      btn.classList.toggle('hide', show);
    }
    document.body.style.overflow = show ? 'hidden' : '';
    if(!show){
      sheet.style.transform='';
      if(overlay) overlay.style.opacity='';
    }
  }

  // Auto-hide toggle on scroll (mobile) & swipe-down to close sheet
  function setupAutoHide(){
    const btn=document.getElementById('filterToggle');
    const scroller=document.querySelector('.main')||window;
    let last=0; let ticking=false;
    const getPos=()=> scroller===window? window.scrollY : scroller.scrollTop;
    const onScroll=()=>{
      if(!btn) return; const curr=getPos();
      if(!ticking){ window.requestAnimationFrame(()=>{ if(curr>last+12) btn.classList.add('hide'); else if(curr<last-12) btn.classList.remove('hide'); last=curr; ticking=false; }); ticking=true; }
    };
    scroller.addEventListener('scroll', onScroll, {passive:true});
  }
  function setupSheetGestures(){
    const sheet=document.getElementById('filterSheet');
    const body=document.getElementById('sheetBody');
    if(!sheet||!body) return;
    let startY=0, currY=0, dragging=false, t0=0;
    const start=(e)=>{ const t=e.touches? e.touches[0] : e; const trg=e.target; const inHead = trg.closest('.sheet-head') || trg.closest('.drag'); const atTop = body.scrollTop <= 2; if(!inHead && !atTop) return; dragging=true; startY=t.clientY; currY=0; t0=Date.now(); sheet.classList.add('dragging'); };
    const move=(e)=>{ if(!dragging) return; const t=e.touches? e.touches[0] : e; currY=Math.max(0, t.clientY-startY); if(currY>0){ sheet.style.transform=`translateY(${currY}px)`; const ov=document.getElementById('overlay'); if(ov) ov.style.opacity=Math.max(0,1-currY/300); e.preventDefault(); } };
    const end=()=>{ if(!dragging) return; dragging=false; const dy=currY; const dt=Math.max(1, Date.now()-t0); const v = dy/dt; const sheetH = sheet.getBoundingClientRect().height || window.innerHeight*0.74; const threshold = sheetH * 0.5; const shouldClose = dy > threshold || v > 0.5; if(shouldClose){ toggleSheet(false); } else { sheet.style.transform='translateY(0)'; setTimeout(()=>{ sheet.style.transform=''; },150); } sheet.classList.remove('dragging'); const ov=document.getElementById('overlay'); if(ov) ov.style.opacity=''; };
    sheet.addEventListener('touchstart', start, {passive:true, capture:false});
    sheet.addEventListener('touchmove', move, {passive:false});
    sheet.addEventListener('touchend', end);
    sheet.addEventListener('touchcancel', end);
    // mouse support (untuk pengujian di desktop)
    sheet.addEventListener('mousedown', start);
    sheet.addEventListener('mousemove', move);
    sheet.addEventListener('mouseup', end);
    sheet.addEventListener('mouseleave', end);
  }

  // Events
  const si=document.getElementById('searchInput');
  si.addEventListener('input',cariSOP);
  si.addEventListener('keydown',e=>{ if(e.key==='Enter') triggerSearchFromButton(); });
  document.addEventListener('keydown',e=>{ if(e.key==='Escape') toggleSheet(false); });

  window.addEventListener('resize', placeFilters);
  document.addEventListener('DOMContentLoaded',()=>{
    document.getElementById('kategori-select').value='klaster1';
    tampilkanSOP();
    renderDashboardStats();
    placeFilters();
    setupAutoHide();
    setupSheetGestures();
  });
  </script>
</body>
</html>
